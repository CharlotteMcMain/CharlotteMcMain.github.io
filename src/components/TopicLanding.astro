---
import { getCollection } from "astro:content";

/**
 * Props passed from the topic page
 */
type Props = {
  title: string;
  topic: string; // e.g. "5_newtonian-world-and-astrophysics"
  description?: string;
  image?: { src: string; alt: string };
  backHref?: string;
  includeUntagged?: boolean;
};

const {
  title,
  topic,
  description = "Notes, past paper walkthroughs, and other resources for this topic.",
  image,
  backHref = "/physics/a-level/",
  includeUntagged = false, // ✅ default off
} = Astro.props;

/**
 * Collect ALL posts, then filter by frontmatter topic
 */
const posts = await getCollection("posts");

const filtered = posts
  .filter((p) => {
    const t = (p.data as any).topic;
    if (t == null || t === "") return includeUntagged; // untagged posts
    return String(t) === topic; // tagged posts
  })
  .map((p) => {
    const d: any = p.data;
    const updated = d.updatedDate ?? d.updated ?? d.pubDate ?? d.date;
    return { ...p, _updated: updated ? new Date(updated) : new Date(0) };
  })
  .sort((a, b) => b._updated.getTime() - a._updated.getTime());
  
/**
 * Group by type
 */
function sectionOf(post: any): "notes" | "past" | "other" {
  const type = String(post.data?.type ?? "").toLowerCase();

  if (type === "notes") return "notes";
  if (type === "past-papers" || type === "past" || type === "walkthrough") return "past";
  return "other";
}

const notes = filtered.filter((p) => sectionOf(p) === "notes");
const past = filtered.filter((p) => sectionOf(p) === "past");
const other = filtered.filter((p) => sectionOf(p) === "other");

const hrefFor = (p: any) => `/${p.id.replace(/\.mdx?$/, "")}/`;
const prettyDate = (p: any) => {
  const d: any = p.data;
  const date = d.updatedDate ?? d.updated ?? d.pubDate ?? d.date;
  return date
    ? new Date(date).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })
    : "";
};
---

<a class="back" href={backHref}>← Back</a>

<header class="hero">
  {image && (
    <div class="heroImgWrap">
      <img src={image.src} alt={image.alt} class="heroImg" loading="lazy" />
    </div>
  )}

  <div>
    <h1>{title}</h1>
    <p>{description}</p>
  </div>
</header>

<section class="block">
  <h2>Notes</h2>
  {notes.length ? (
    <ol class="list">
      {notes.map((p) => (
        <li>
          <a href={hrefFor(p)}>{p.data.title}</a>
          <span class="date">{prettyDate(p)}</span>
        </li>
      ))}
    </ol>
  ) : (
    <p class="empty">No notes yet.</p>
  )}
</section>

<section class="block">
  <h2>Past paper walkthroughs</h2>
  {past.length ? (
    <ol class="list">
      {past.map((p) => (
        <li>
          <a href={hrefFor(p)}>{p.data.title}</a>
          <span class="date">{prettyDate(p)}</span>
        </li>
      ))}
    </ol>
  ) : (
    <p class="empty">No walkthroughs yet.</p>
  )}
</section>

<section class="block">
  <h2>Other</h2>
  {other.length ? (
    <ol class="list">
      {other.map((p) => (
        <li>
          <a href={hrefFor(p)}>{p.data.title}</a>
          <span class="date">{prettyDate(p)}</span>
        </li>
      ))}
    </ol>
  ) : (
    <p class="empty">Nothing else here yet.</p>
  )}
</section>

<style>
  .back {
    display: inline-block;
    opacity: 0.8;
    margin: 0.5rem 0 1rem;
    text-decoration: none;
  }

  .hero {
    display: grid;
    grid-template-columns: 180px 1fr;
    gap: 1.25rem;
    align-items: center;
    margin-bottom: 1.5rem;
  }

  .heroImgWrap {
    border-radius: 16px;
    overflow: hidden;
    border: 2px solid var(--callout-border, rgba(255,255,255,.15));
    background: var(--callout-bg, rgba(255,255,255,.03));
    aspect-ratio: 1 / 1;
  }

  .heroImg {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .block {
    margin: 1.75rem 0;
  }

  .list {
    padding-left: 1.1rem;
    margin-top: 0.75rem;
  }

  .list li {
    display: flex;
    justify-content: space-between;
    gap: 0.75rem;
    margin: 0.35rem 0;
  }

  .list a {
    font-weight: 600;
    text-decoration: none;
  }

  .date {
    opacity: 0.7;
    white-space: nowrap;
  }

  .empty {
    opacity: 0.7;
  }

  @media (max-width: 720px) {
    .hero {
      grid-template-columns: 1fr;
    }
    .heroImgWrap {
      max-width: 220px;
    }
  }
</style>