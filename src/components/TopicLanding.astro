---
import { getCollection } from "astro:content";

/**
 * Props passed from the topic page
 */
type Props = {
  title: string;
  topic: string; // e.g. "5_newtonian-world-and-astrophysics"
  description?: string;
  image?: { src: string; alt: string };
  backHref?: string;
  includeUntagged?: boolean;
};

const {
  title,
  topic,
  description = "Notes, past paper walkthroughs, and other resources for this topic.",
  image,
  backHref = "/physics/a-level/",
  includeUntagged = false, // ✅ default off
} = Astro.props;

/**
 * Collect ALL posts, then filter by frontmatter topic
 */
const posts = await getCollection("posts");

const filtered = posts
  .filter((p) => {
    const t = (p.data as any).topic;
    if (t == null || t === "") return includeUntagged; // untagged posts
    return String(t) === topic; // tagged posts
  })
  .map((p) => {
    const d: any = p.data;
    const updated = d.updatedDate ?? d.updated ?? d.pubDate ?? d.date;
    return { ...p, _updated: updated ? new Date(updated) : new Date(0) };
  })
  .sort((a, b) => b._updated.getTime() - a._updated.getTime());
  
/**
 * Group by type
 */
function sectionOf(post: any): "notes" | "past" | "other" {
  const type = String(post.data?.type ?? "").toLowerCase();

  if (type === "notes") return "notes";
  if (type === "past-papers" || type === "past" || type === "walkthrough") return "past";
  return "other";
}

const notes = filtered.filter((p) => sectionOf(p) === "notes");
const past = filtered.filter((p) => sectionOf(p) === "past");
const other = filtered.filter((p) => sectionOf(p) === "other");

const hrefFor = (p: any) => `/${p.slug}/`;
const prettyDate = (p: any) => {
  const d: any = p.data;
  const date = d.updatedDate ?? d.updated ?? d.pubDate ?? d.date;
  return date
    ? new Date(date).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })
    : "";
};
---

<header class="hero">
  {image && (
    <img
      class="heroBg"
      src={image.src}
      alt={image.alt}
      loading="lazy"
    />
  )}

  <div class="heroOverlay"></div>

  <div class="heroInner">
    <a class="back" href={backHref}>← Back to A-level Physics</a>
    <h1>{title}</h1>
    <p>{description}</p>
  </div>
</header>

<section class="block">
  <h2>Notes</h2>
  {notes.length ? (
    <ol class="list">
      {notes.map((p) => (
        <li>
          <a href={hrefFor(p)}>{p.data.title}</a>
          <span class="date">{prettyDate(p)}</span>
        </li>
      ))}
    </ol>
  ) : (
    <p class="empty">No notes yet.</p>
  )}
</section>

<section class="block">
  <h2>Past paper walkthroughs</h2>
  {past.length ? (
    <ol class="list">
      {past.map((p) => (
        <li>
          <a href={hrefFor(p)}>{p.data.title}</a>
          <span class="date">{prettyDate(p)}</span>
        </li>
      ))}
    </ol>
  ) : (
    <p class="empty">No walkthroughs yet.</p>
  )}
</section>

<section class="block">
  <h2>Other</h2>
  {other.length ? (
    <ol class="list">
      {other.map((p) => (
        <li>
          <a href={hrefFor(p)}>{p.data.title}</a>
          <span class="date">{prettyDate(p)}</span>
        </li>
      ))}
    </ol>
  ) : (
    <p class="empty">Nothing else here yet.</p>
  )}
</section>

<style>
  .hero {
    position: relative;
    width: 100%;
    min-height: 320px;
    margin-bottom: 2.25rem;
    display: flex;
    align-items: center;
  }

  .heroBg {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .heroOverlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      rgba(0,0,0,0.45),
      rgba(0,0,0,0.65)
    );
  }

  .heroInner {
    position: relative;
    z-index: 1;
    width: 100%;
    max-width: 1000px;          /* match your SiteLayout width */
    padding: 2.25rem 1.25rem;
    margin: 0 auto;
    color: white;
  }

  .heroInner h1 {
    margin: 0 0 .5rem;
  }

  .heroInner p {
    margin: 0;
    max-width: 65ch;
    opacity: 0.9;
  }

  .back {
    display: inline-block;
    margin-bottom: 0.75rem;
    text-decoration: none;
    color: white;
    opacity: 0.85;
  }

  .back:hover {
    opacity: 1;
  }

  @media (max-width: 720px) {
    .hero {
      min-height: 260px;
    }
  }

  .block {
    margin: 1.75rem 0;
  }

  .list {
    padding-left: 1.1rem;
    margin-top: 0.75rem;
  }

  .list li {
    display: flex;
    justify-content: space-between;
    gap: 0.75rem;
    margin: 0.35rem 0;
  }

  .list a {
    font-weight: 600;
    text-decoration: none;
  }

  .date {
    opacity: 0.7;
    white-space: nowrap;
  }

  .empty {
    opacity: 0.7;
  }
  }
</style>